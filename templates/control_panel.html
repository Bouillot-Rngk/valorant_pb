<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>BO Pick & Ban Control Panel</title>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.5.4/socket.io.min.js"></script>
  <style>
    @font-face {
      font-family: 'Saira Bold';
      src: url("static/fonts/Saira-Bold.ttf") format('truetype');
      font-weight: bold;
    }
    body {
      font-family: 'Saira Bold', sans-serif;
      background-color: #222;
      color: #fff;
      text-align: center;
      padding: 20px;
    }
    .section {
      margin: 20px auto;
      max-width: 800px;
      background: #333;
      padding: 20px;
      border-radius: 8px;
    }
    input[type="text"], input[type="number"] {
      padding: 5px;
      font-size: 1em;
      border-radius: 4px;
      border: none;
      margin: 5px;
    }
    .action-section {
      margin-top: 20px;
    }
    .options {
      margin: 15px 0;
    }
    label {
      margin: 0 10px;
      font-size: 1.2em;
    }
    button {
      padding: 10px 20px;
      font-size: 1.2em;
      background: #8cba11;
      border: none;
      border-radius: 4px;
      cursor: pointer;
      margin: 5px;
    }
    button:hover {
      background: #7aa00e;
    }
  </style>
</head>
<body>
  <h1>BO Pick & Ban Control Panel</h1>
  
  <!-- BO Type Selection at the very top -->
  <div class="section">
    <h2>BO Type Selection</h2>
    <label for="boType">BO Type:</label>
    <select id="boType">
      <option value="3" selected>BO3</option>
      <option value="5">BO5</option>
    </select>
  </div>
  
  <!-- Team Information Section -->
  <div class="section">
    <h2>Team Information</h2>
    <input type="text" id="teamA" placeholder="Team A Name">
    <input type="text" id="teamB" placeholder="Team B Name">
    <button onclick="updateTeams()">Update Teams</button>
  </div>
  
  <!-- Action Section (Pick & Ban) -->
  <div class="section action-section">
    <h2 id="instruction">Instruction: </h2>
    <div class="options" id="options"></div>
    <button onclick="submitAction()">Submit Action</button>
  </div>
  
  <!-- BO Tracking Section -->
  <div class="section">
    <h2>BO Tracking</h2>
    <label for="currentMapIndex">Current Map:</label>
    <div id="currentMapContainer">
      <!-- Initial radio group for BO3 (3 maps) -->
      <label><input type="radio" name="currentMap" value="0"> Map 1</label>
      <label><input type="radio" name="currentMap" value="1" checked> Map 2</label>
      <label><input type="radio" name="currentMap" value="2"> Map 3</label>
    </div>
    <br>
    <!-- Score Inputs -->
    <div id="scoreInputs">
      <label id="score1Label" for="score1">Map 1 Score:</label>
      <input type="text" id="score1" placeholder="e.g., 13-8">
      <br>
      <label id="score2Label" for="score2">Map 2 Score:</label>
      <input type="text" id="score2" placeholder="e.g., 8-13">
      <br>
      <label id="score3Label" for="score3">Map 3 Score:</label>
      <input type="text" id="score3" placeholder="e.g., 13-10">
      <br>
      <div id="extraScore" style="display: none;">
        <label id="score4Label" for="score4">Map 4 Score:</label>
        <input type="text" id="score4" placeholder="e.g., 0-0">
        <br>
        <label id="score5Label" for="score5">Map 5 Score:</label>
        <input type="text" id="score5" placeholder="e.g., 0-0">
        <br>
      </div>
    </div>
    <br>
    <label id="seriesScoreALabel" for="seriesScoreA">TeamA Series Score:</label>
    <input type="number" id="seriesScoreA" value="0" min="0">
    <br>
    <label id="seriesScoreBLabel" for="seriesScoreB">TeamB Series Score:</label>
    <input type="number" id="seriesScoreB" value="0" min="0">
    <br>
    <button onclick="submitTracking()">Update BO Tracking</button>
  </div>
  
  <!-- Reset Buttons -->
  <div class="section">
    <button onclick="resetState()">Reset BO Pick/Ban</button>
    <button onclick="resetTracking()">Reset BO Tracking</button>
  </div>
  
  <script>
    const socket = io();
    let currentStep = 0;
    let state = {};
    
    // Update current map radio group based on BO Type
    function updateCurrentMapOptions() {
      const boType = document.getElementById('boType').value;
      const container = document.getElementById('currentMapContainer');
      container.innerHTML = "";
      let numOptions = (boType == "5") ? 5 : 3;
      for(let i = 0; i < numOptions; i++){
        const label = document.createElement('label');
        // Default check the second option (index 1) if available, else index 0.
        const checked = (i === ((numOptions > 1) ? 1 : 0)) ? "checked" : "";
        label.innerHTML = `<input type="radio" name="currentMap" value="${i}" ${checked}> Map ${i+1}`;
        container.appendChild(label);
      }
    }
    
    // Listen for changes to the BO Type dropdown
    document.getElementById('boType').addEventListener('change', updateCurrentMapOptions);
    // Initialize on load
    updateCurrentMapOptions();
    
    socket.on('state_updated', function(newState) {
      state = newState;
      currentStep = state.step;
      updateInstruction();
      // Update score labels if maps are picked:
      if(state.map1.map !== "TBD"){
        document.getElementById('score1Label').innerText = state.map1.map + " Score:";
      } else {
        document.getElementById('score1Label').innerText = "Map 1 Score:";
      }
      if(state.map2.map !== "TBD"){
        document.getElementById('score2Label').innerText = state.map2.map + " Score:";
      } else {
        document.getElementById('score2Label').innerText = "Map 2 Score:";
      }
      if(state.map3.map !== "TBD"){
        document.getElementById('score3Label').innerText = state.map3.map + " Score:";
      } else {
        document.getElementById('score3Label').innerText = "Map 3 Score:";
      }
      // If BO5, also show extra score inputs.
      if(state.boType == 5) {
        document.getElementById('extraScore').style.display = "block";
        if(state.map4 && state.map4.map !== "TBD"){
          document.getElementById('score4Label').innerText = state.map4.map + " Score:";
        } else {
          document.getElementById('score4Label').innerText = "Map 4 Score:";
        }
        if(state.map5 && state.map5.map !== "TBD"){
          document.getElementById('score5Label').innerText = state.map5.map + " Score:";
        } else {
          document.getElementById('score5Label').innerText = "Map 5 Score:";
        }
      } else {
        document.getElementById('extraScore').style.display = "none";
      }
      // Update series score labels with team names.
      if(state.teamA && state.teamA !== "Team A"){
        document.getElementById('seriesScoreALabel').innerText = state.teamA.toUpperCase() + " Series Score:";
      } else {
        document.getElementById('seriesScoreALabel').innerText = "TeamA Series Score:";
      }
      if(state.teamB && state.teamB !== "Team B"){
        document.getElementById('seriesScoreBLabel').innerText = state.teamB.toUpperCase() + " Series Score:";
      } else {
        document.getElementById('seriesScoreBLabel').innerText = "TeamB Series Score:";
      }
    });
    
    function updateTeams() {
      const teamA = document.getElementById('teamA').value;
      const teamB = document.getElementById('teamB').value;
      socket.emit('update_teams', { teamA, teamB });
    }
    
    function updateInstruction() {
      const instr = document.getElementById('instruction');
      const optionsDiv = document.getElementById('options');
      // Preserve previous selection if any.
      let currentValue = "";
      const existing = document.querySelector('input[name="map"]:checked, input[name="side"]:checked');
      if(existing) currentValue = existing.value;
      optionsDiv.innerHTML = "";
      let text = "";
      
      if (currentStep === 0) {
        text = state.teamA + " ban a map:";
        createRadioOptions(state.available_maps, "map", currentValue);
      } else if (currentStep === 1) {
        text = state.teamB + " ban a map:";
        createRadioOptions(state.available_maps, "map", currentValue);
      } else if (currentStep === 2) {
        text = state.teamA + " pick map for Map 1:";
        createRadioOptions(state.available_maps, "map", currentValue);
      } else if (currentStep === 3) {
        text = state.teamB + " pick side for Map 1:";
        createRadioOptions(["attack", "defense"], "side", currentValue);
      } else if (currentStep === 4) {
        text = state.teamB + " pick map for Map 2:";
        createRadioOptions(state.available_maps, "map", currentValue);
      } else if (currentStep === 5) {
        text = state.teamA + " pick side for Map 2:";
        createRadioOptions(["attack", "defense"], "side", currentValue);
      }
      else if (state.boType == 3 && currentStep === 6) {
        text = state.teamA + " ban a map:";
        createRadioOptions(state.available_maps, "map", currentValue);
      } else if (state.boType == 3 && currentStep === 7) {
        text = state.teamB + " pick map for Map 3:";
        createRadioOptions(state.available_maps, "map", currentValue);
      } else if (state.boType == 3 && currentStep === 8) {
        text = state.teamA + " pick side for Map 3:";
        createRadioOptions(["attack", "defense"], "side", currentValue);
      }
      // BO5 steps:
      else if (state.boType == 5) {
        if (currentStep === 6) {
          text = state.teamA + " pick map for Map 3:";
          createRadioOptions(state.available_maps, "map", currentValue);
        } else if (currentStep === 7) {
          text = state.teamB + " pick side for Map 3:";
          createRadioOptions(["attack", "defense"], "side", currentValue);
        } else if (currentStep === 8) {
          text = state.teamB + " pick map for Map 4:";
          createRadioOptions(state.available_maps, "map", currentValue);
        } else if (currentStep === 9) {
          text = state.teamA + " pick side for Map 4:";
          createRadioOptions(["attack", "defense"], "side", currentValue);
        } else if (currentStep === 10) {
          text = state.teamB + " pick map for Map 5:";
          createRadioOptions(state.available_maps, "map", currentValue);
        } else if (currentStep === 11) {
          text = state.teamA + " pick side for Map 5:";
          createRadioOptions(["attack", "defense"], "side", currentValue);
        } else {
          text = "BO5 process completed.";
          optionsDiv.innerHTML = "";
        }
      } else {
        text = "Process completed.";
        optionsDiv.innerHTML = "";
      }
      instr.innerText = text;
    }
    
    function createRadioOptions(optionsArray, name, prevSelected) {
      const optionsDiv = document.getElementById('options');
      optionsArray.forEach(option => {
        const label = document.createElement('label');
        const isChecked = (option === prevSelected) ? "checked" : "";
        label.innerHTML = `<input type="radio" name="${name}" value="${option}" ${isChecked}> ${option}`;
        optionsDiv.appendChild(label);
      });
    }
    
    function submitAction() {
      let data = {};
      if ((state.boType == 3 && [0, 1, 2, 4, 6, 7].includes(currentStep)) ||
          (state.boType == 5 && ([0,1,2,4,6,8,10].includes(currentStep)))) {
        const selected = document.querySelector(`input[name="map"]:checked`);
        data.map = selected ? selected.value : "TBD";
      } else if ((state.boType == 3 && [3, 5, 8].includes(currentStep)) ||
                 (state.boType == 5 && ([3,5,7,9,11].includes(currentStep)))) {
        const selected = document.querySelector(`input[name="side"]:checked`);
        data.side = selected ? selected.value : "TBD";
      }
      // Also send the boType from the dropdown.
      data.boType = document.getElementById('boType').value;
      socket.emit('update_action', data);
    }
    
    function resetState() {
      socket.emit('reset_state');
    }
    
    function submitTracking() {
      const boType = document.getElementById('boType').value;
      const currentMapIndex = document.querySelector('input[name="currentMap"]:checked').value;
      const score1 = document.getElementById('score1').value || "TBD";
      const score2 = document.getElementById('score2').value || "TBD";
      const score3 = document.getElementById('score3').value || "TBD";
      let score4 = "TBD", score5 = "TBD";
      if(boType == 5) {
        score4 = document.getElementById('score4').value || "TBD";
        score5 = document.getElementById('score5').value || "TBD";
      }
      const seriesScoreA = document.getElementById('seriesScoreA').value || "0";
      const seriesScoreB = document.getElementById('seriesScoreB').value || "0";
      
      socket.emit('update_bo_tracking', {
        boType: boType,
        currentMapIndex: currentMapIndex,
        score1: score1,
        score2: score2,
        score3: score3,
        score4: score4,
        score5: score5,
        seriesScoreA: seriesScoreA,
        seriesScoreB: seriesScoreB
      });
    }
    
    function resetTracking() {
      socket.emit('reset_bo_tracking');
    }
  </script>
</body>
</html>
